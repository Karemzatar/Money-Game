<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wallet - Money Game</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="home.html" class="nav-logo">ðŸ’° Money Game</a>
      <ul class="nav-menu">
        <li><a href="home.html">Home</a></li>
        <li><a href="paybal-wallet.html" class="active">Wallet</a></li>
        <li><a href="javascript:handleLogout()" class="logout-btn">Logout</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">

    <!-- Login Section -->
    <div id="loginSection" class="login-box" style="margin-top: 50px;">
      <h2>ðŸ’³ Secure Wallet Access</h2>
      <p style="margin-bottom:20px; color:#666;">Enter your PIN to access funds.</p>

      <div id="errorMessage" style="color: red; margin-bottom: 15px;"></div>

      <form onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Company/Card Number</label>
          <input id="loginInput" type="text" placeholder="Enter ID" required>
        </div>
        <div class="form-group">
          <label>Security PIN</label>
          <input id="pinInput" type="password" placeholder="****" maxlength="8" required>
        </div>
        <button type="submit" class="btn btn-primary">Unlock Wallet</button>
      </form>
    </div>

    <!-- Wallet Dashboard -->
    <div id="walletSection" style="display: none;">
      <div class="visa-card-container">
        <div class="visa-card">
          <div class="card-logo">ðŸ’°</div>
          <div class="card-number" id="displayCardNumber">0000 0000 0000 0000</div>
          <div class="card-bottom">
            <div class="card-holder">
              <small>CARDHOLDER</small>
              <h3 id="displayCompanyName">Company</h3>
            </div>
            <div class="card-brand">VISA</div>
          </div>
        </div>

        <div class="card-info">
          <h2 style="color: #667eea; margin-bottom: 10px;">Wallet Balance</h2>
          <div class="stat-value" id="displayBalance" style="font-size: 36px;">$0.00</div>
          <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
          <p><strong>Manager:</strong> <span id="displayManagerName">-</span></p>
          <p><strong>Health:</strong> <span id="healthScoreDisplay">100</span>%</p>
          <button class="btn btn-small-secondary" onclick="handleLogout()" style="margin-top: 10px;">Lock
            Wallet</button>
        </div>
      </div>

      <!-- Transfer -->
      <div class="card-base">
        <h3>ðŸ“¤ Send Money</h3>
        <p style="color:#666; margin-bottom: 20px;">Securely transfer funds to other companies.</p>

        <form id="transferForm" onsubmit="preHookTransfer(event)">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
              <label>Recipient ID/Name</label>
              <input id="recipientInput" type="text" placeholder="e.g. Wailand" required>
            </div>
            <div class="form-group">
              <label>Amount ($)</label>
              <input id="amountInput" type="number" placeholder="0.00" min="0.01" step="0.01" required>
            </div>
          </div>
          <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Send Funds</button>
        </form>

        <div id="successMessage" style="color: green; margin-top: 15px; font-weight: bold;"></div>
        <div id="errorMessageDash" style="color: red; margin-top: 15px;"></div>
      </div>
    </div>
  </div>

  <!-- JavaScript logic embedded for simplicity/consistency with previous -->
  <script>
    let currentUser = null;
    let pendingTransfer = null;

    // Auto-fill login if coming from home
    const cId = sessionStorage.getItem("companyId");
    if (cId) {
      // We can't auto-login without PIN, but we can pre-fill
      // Actually, for security, maybe just force fresh login here as requested?
      // "make if someone login to her commpnay send hem to home not wallet" -> handled in login.js
    }

    async function handleLogin(event) {
      event.preventDefault();
      const loginInput = document.getElementById('loginInput').value.trim();
      const pinInput = document.getElementById('pinInput').value.trim();
      const err = document.getElementById('errorMessage');
      err.innerText = '';

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ loginId: loginInput, pin: pinInput })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        currentUser = data;
        showWallet();
      } catch (e) {
        err.innerText = e.message;
      }
    }

    function showWallet() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('walletSection').style.display = 'block';
      updateDisplay();
    }

    function updateDisplay() {
      if (!currentUser) return;
      document.getElementById('displayCardNumber').innerText = currentUser.cardNumber.replace(/(\d{4})(?=\d)/g, '$1 ');
      document.getElementById('displayCompanyName').innerText = currentUser.company;
      document.getElementById('displayManagerName').innerText = currentUser.manager;
      document.getElementById('displayBalance').innerText = '$' + Number(currentUser.balance).toLocaleString("en-US", { minimumFractionDigits: 2 });
      document.getElementById('healthScoreDisplay').innerText = currentUser.healthScore;
    }

    function handleLogout() {
      currentUser = null;
      document.getElementById('walletSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('pinInput').value = '';
    }

    function preHookTransfer(e) {
      e.preventDefault();
      const recipient = document.getElementById('recipientInput').value;
      const amount = document.getElementById('amountInput').value;

      if (confirm(`Send $${amount} to ${recipient}?`)) {
        executeTransfer(recipient, amount);
      }
    }

    async function executeTransfer(recipient, amount) {
      try {
        const res = await fetch('/api/transfer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            senderId: currentUser.id,
            recipientId: recipient,
            amount: amount
          })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        currentUser.balance = data.newBalance;
        updateDisplay();
        document.getElementById('successMessage').innerText = "Transfer Successful!";
        setTimeout(() => document.getElementById('successMessage').innerText = '', 3000);
        document.getElementById('transferForm').reset();
      } catch (e) {
        document.getElementById('errorMessageDash').innerText = e.message;
        setTimeout(() => document.getElementById('errorMessageDash').innerText = '', 3000);
      }
    }
  </script>
</body>

</html>