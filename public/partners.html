<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#4CAF50">
  <title>Partners</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="manifest" href="/manifest.json">
</head>

<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="home.html" class="nav-logo">üí∞ Money Game</a>
      <ul class="nav-menu">
        <li><a href="home.html">Home</a></li>
        <li><a href="paybal-wallet.html">Wallet</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="card-base">
      <h1>ü§ù Partnerships</h1>
      <p style="margin-bottom: 20px; color: #666;">Partner with other companies to boost earnings by +25% and increase
        share price.</p>
      <button class="btn btn-secondary" onclick="location.href='home.html'" style="width: auto;">‚Üê Back Home</button>
    </div>

    <div class="card-base">
      <h3>Incoming Requests</h3>
      <div id="requestsList" style="margin-top: 15px;">Loading...</div>
    </div>

    <div class="card-base">
      <h3>My Partners</h3>
      <div id="partnersList" style="margin-top: 15px;">Loading...</div>
    </div>

    <div class="card-base">
      <h3>Request Partnership</h3>
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <input type="text" id="partnerSearch" placeholder="Enter Company Name..." style="flex: 1;">
        <button class="btn btn-primary" onclick="sendRequest()" style="width: auto;">Send Request</button>
      </div>
    </div>
  </div>

  <script>
    const companyId = sessionStorage.getItem("companyId");
    if (!companyId) location.href = '/';

    async function loadPartners() {
      const res = await fetch(`/data/${companyId}`);
      const data = await res.json();
      const reqList = document.getElementById('requestsList');
      const partList = document.getElementById('partnersList');

      reqList.innerHTML = '';
      partList.innerHTML = '';

      if (data.partnershipRequests.length === 0) reqList.innerHTML = '<p style="color:#999;">No pending requests.</p>';
      else {
        data.partnershipRequests.forEach(r => {
          const div = document.createElement('div');
          div.style.padding = '15px';
          div.style.border = '1px solid #eee';
          div.style.borderRadius = '10px';
          div.style.marginBottom = '10px';
          div.style.display = 'flex';
          div.style.justifyContent = 'space-between';
          div.style.alignItems = 'center';
          div.innerHTML = `<span><b>${r.fromName}</b> wants to join forces!</span> <button class="btn btn-primary" style="width:auto; padding: 8px 15px;" onclick="accept('${r.fromId}')">Accept</button>`;
          reqList.appendChild(div);
        });
      }

      if (data.partners.length === 0) partList.innerHTML = '<p style="color:#999;">No partners yet.</p>';
      else {
        // Fetch all helper
        const allRes = await fetch('/api/companies');
        const all = await allRes.json();

        data.partners.forEach(pid => {
          const p = all.find(c => c.id === pid);
          const name = p ? p.company : "Unknown Company";
          const div = document.createElement('div');
          div.style.padding = '15px';
          div.style.background = '#f9f9f9';
          div.style.borderRadius = '10px';
          div.style.marginBottom = '10px';
          div.innerHTML = `<b>ü§ù ${name}</b> <span style="color:green; float:right;">Active (+25% Boost)</span>`;
          partList.appendChild(div);
        });
      }
    }

    async function accept(requesterId) {
      await fetch('/api/partners/accept', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ acceptorId: companyId, requesterId })
      });
      loadPartners();
    }

    async function sendRequest() {
      const name = document.getElementById('partnerSearch').value;
      if (!name) return;

      const allRes = await fetch(`/api/companies?q=${name}`);
      const all = await allRes.json();
      const target = all.find(c => c.company.toLowerCase() === name.toLowerCase());

      if (!target) { alert("Company not found"); return; }
      if (target.id === companyId) { alert("Cannot partner with yourself"); return; }

      await fetch('/api/partners/request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ requesterId: companyId, targetCompanyId: target.id })
      });
      alert("Request sent!");
      document.getElementById('partnerSearch').value = '';
    }

    loadPartners();
  </script>
  <script src="/js/pwa-setup.js"></script>
</body>

</html>


