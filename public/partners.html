<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Partners</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .partner-card {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section {
      margin-bottom: 30px;
    }
  </style>
</head>

<body class="home-page">
  <div class="container">
    <h1>ü§ù Partnerships</h1>
    <button class="btn btn-secondary" onclick="location.href='home.html'">‚Üê Back Home</button>

    <div class="section">
      <h3>Incoming Requests</h3>
      <div id="requestsList">Loading...</div>
    </div>

    <div class="section">
      <h3>My Partners</h3>
      <div id="partnersList">Loading...</div>
    </div>

    <div class="section">
      <h3>Request Partnership</h3>
      <input type="text" id="partnerSearch" placeholder="Enter Company Name to Request"
        style="padding:10px; width:100%;">
      <button class="btn btn-primary" onclick="sendRequest()" style="margin-top:10px;">Send Request</button>
    </div>
  </div>

  <script>
    const companyId = sessionStorage.getItem("companyId");
    if (!companyId) location.href = '/';

    async function loadPartners() {
      const res = await fetch(`/data/${companyId}`);
      const data = await res.json();

      const reqList = document.getElementById('requestsList');
      const partList = document.getElementById('partnersList');

      reqList.innerHTML = '';
      partList.innerHTML = ''; // In real app, we need to fetch partner names, but data only has IDs probably? 
      // The data endpoint returns `partnershipRequests` with names: {fromId, fromName}.

      if (data.partnershipRequests.length === 0) reqList.innerHTML = '<p>No pending requests.</p>';
      data.partnershipRequests.forEach(r => {
        const div = document.createElement('div');
        div.className = 'partner-card';
        div.innerHTML = `
                    <span><b>${r.fromName}</b> wants to partner!</span>
                    <button class="btn btn-small-primary" onclick="accept('${r.fromId}')">Accept</button>
                `;
        reqList.appendChild(div);
      });

      // For partners array, we just have IDs. We might need to fetch their names or just show Count. 
      // Ideally we'd have a 'get multiple companies' endpoint or cache.
      // For now, let's just list the IDs or "Partner #1".
      if (data.partners.length === 0) partList.innerHTML = '<p>No partners yet.</p>';
      else {
        // Determine names - fetch all companies is expensive but we have the endpoint
        // Let's do a quick lazy load
        const allRes = await fetch('/api/companies'); // This is light enough (only safe data)
        const all = await allRes.json();

        data.partners.forEach(pid => {
          const p = all.find(c => c.id === pid);
          const name = p ? p.company : "Unknown Company";
          const div = document.createElement('div');
          div.className = 'partner-card';
          div.innerHTML = `<span>ü§ù ${name}</span> <span style="color:green;">Active (+25% Bonus)</span>`;
          partList.appendChild(div);
        });
      }
    }

    async function accept(requesterId) {
      await fetch('/api/partners/accept', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ acceptorId: companyId, requesterId })
      });
      loadPartners();
    }

    async function sendRequest() {
      const name = document.getElementById('partnerSearch').value;
      // First find the ID
      const allRes = await fetch(`/api/companies?q=${name}`);
      const all = await allRes.json();
      const target = all.find(c => c.company.toLowerCase() === name.toLowerCase());

      if (!target) { alert("Company not found"); return; }

      await fetch('/api/partners/request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ requesterId: companyId, targetCompanyId: target.id })
      });
      alert("Request sent!");
    }

    loadPartners();
  </script>
</body>

</html>