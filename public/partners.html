<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#4CAF50">
  <title>Partners</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="manifest" href="/manifest.json">
</head>

<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="home.html" class="nav-logo">üí∞ Money Game</a>
      <ul class="nav-menu">
        <li><a href="home.html">Home</a></li>
        <li><a href="paybal-wallet.html">Wallet</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="card-base">
      <h1>ü§ù Partnerships</h1>
      <p style="margin-bottom: 20px; color: #666;">Partner with other companies to boost earnings by +25% and increase
        share price.</p>
      <button class="btn btn-secondary" onclick="location.href='home.html'" style="width: auto;">‚Üê Back Home</button>
    </div>

    <div class="card-base">
      <h3>Incoming Requests</h3>
      <div id="requestsList" style="margin-top: 15px;">Loading...</div>
    </div>

    <div class="card-base">
      <h3>My Partners</h3>
      <div id="partnersList" style="margin-top: 15px;">Loading...</div>
    </div>

    <div class="card-base">
      <h3>Request Partnership</h3>
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <input type="text" id="partnerSearch" placeholder="Enter Company Name..." style="flex: 1;">
        <button class="btn btn-primary" onclick="sendRequest()" style="width: auto;">Send Request</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', loadPartners);

    async function loadPartners() {
      // 1. Get Requests
      try {
        const res = await fetch('/api/game/partners'); // using listPartners which returns partners (both active and pending involving me)
        if (res.status === 401) { window.location.href = 'login.html'; return; }

        const data = await res.json();
        const reqList = document.getElementById('requestsList');
        const partList = document.getElementById('partnersList');

        reqList.innerHTML = '';
        partList.innerHTML = '';

        const all = data.partners || [];
        // Filter pending where I am user_id_2 (receiver)
        // Adjust logic based on listPartners response in CompanyController

        // Let's assume listPartners returns array of objects with { id, user_id_1, user_id_2, status, other_user }
        // Since we don't know my ID easily in frontend without fetching profile, we rely on 'other_user' field from backend?
        // Backend `listPartners` query: `... u.username as other_user ... WHERE ...`

        // Wait, I need to know which one is ME to know if it's incoming or outgoing.
        // Actually the backend `listPartners` returns all.
        // I should probably fetch profile first to get my username/id to filter properly?
        // Or just display "Pending with X".

        if (all.length === 0) {
          reqList.innerHTML = '<p>No pending requests.</p>';
          partList.innerHTML = '<p>No active partners.</p>';
        }

        all.forEach(p => {
          if (p.status === 'active') {
            const div = document.createElement('div');
            div.className = 'upgrade-item';
            div.style.background = '#fcfcfc';
            div.style.color = '#333';
            div.innerHTML = `<strong>${p.other_user}</strong> <span style="color:green; float:right;">Active (+1.5x Boost)</span>`;
            partList.appendChild(div);
          } else {
            // Pending
            const div = document.createElement('div');
            div.className = 'upgrade-item';
            div.style.background = '#fff';
            div.style.border = '1px solid #ccc';
            div.style.color = '#333';

            // If I am the sender (user_id_1), I am waiting. If I am receiver (user_id_2), I should accept.
            // Backend: `u.id != ?` returns the OTHER user name.
            // But we need to know if we can Accept.
            // We can check if 'other_user' is the one I sent to? No, 'other_user' is the partner.
            // We need to know who initiated.

            // Ideally backend sends `is_sender` boolean. 
            // Let's just show Accept button for all for simplicity/MVP or assume we can try to accept.
            // If we are the sender, Accept will likely fail or do nothing (since we can't accept our own request).
            // Better: "Pending with..."

            div.innerHTML = `
                    <span>Request with <b>${p.other_user}</b></span>
                    <div style="float:right;">
                        <button class="btn btn-primary" style="padding:5px 10px; font-size:12px;" onclick="respond('${p.id}', true)">Accept</button>
                        <button class="btn btn-secondary" style="padding:5px 10px; font-size:12px;" onclick="respond('${p.id}', false)">Reject</button>
                    </div>
                 `;
            reqList.appendChild(div);
          }
        });

      } catch (e) { console.error(e); }
    }

    async function respond(partnerId, accept) {
      try {
        const res = await fetch('/api/game/partners/respond', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ partnerId, accept })
        });
        const data = await res.json();
        if (data.success) {
          alert(data.message);
          loadPartners();
        } else {
          alert(data.error);
        }
      } catch (e) { console.error(e); }
    }

    async function sendRequest() {
      const name = document.getElementById('partnerSearch').value;
      if (!name) return;

      // 1. Search for company/user
      try {
        const res = await fetch(`/api/game/search-companies?query=${name}`);
        const data = await res.json();

        if (!data.companies || data.companies.length === 0) {
          alert("Company not found");
          return;
        }

        // Just pick the first one
        const target = data.companies[0];

        const res2 = await fetch('/api/game/partners/request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ targetCompanyId: target.id }) // Backend expects targetCompanyId (which is actually Company ID, not User ID in my backend logic step 52? 
          // Step 52 logic: "check if target company exists... targetUserId = targetCompany.user_id". 
          // So we need to pass a Company ID.
          // My searchCompanies (Step 26 duplicates) returns Companies (Line 75) or Users (Line 126).
          // I should verify searchCompanies behavior.
          // If it returns Companies, `target.id` is Company ID. Correct.
        });
        const d2 = await res2.json();
        if (d2.success) {
          alert("Request sent!");
          document.getElementById('partnerSearch').value = '';
          loadPartners();
        } else {
          alert(d2.error);
        }
      } catch (e) {
        alert("Error: " + e.message);
      }
    }
  </script>
  <script src="/js/pwa-setup.js"></script>
</body>

</html>